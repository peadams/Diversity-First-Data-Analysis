---
title: "DiversityFirst Quantitative Data Analysis"
author: "Paula Adams"
date: "20230420"
output: 
  html_document:
    toc: true
    toc_float: true
    theme: "lumen"
---

Date rendered: `r date()`

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = "/Users/Owner/Library/CloudStorage/Box-Box/Diversity First Project/Data_Analysis/")
getwd()

```

```{r,include=FALSE}
#clear memory
rm(list=ls())

#libraries
library(tidyverse)
library(ggplot2)
library(scales) # has percent scale
library(emmeans) # estimated marginal means package
library(ggstats) # gglikert
library(cowplot) # cowplot is a clean theme for ggplot, also has the function plot_grid to combine plts
library(paletteer) # color palettes 
library(superb) # add significance to figures easily 
library(lme4)
```
#Set-Up and Data

Included Packages:

tidyverse, ggplot2, scales (has percent scale for graphs), emmeans, ggstats (for gglikert plots), cowplot (a clean theme for ggplot, also has the function plot_grid to combine plots), paletteer (for color palettes), and superb (to add significance to figures) 

```{r}

options(contrasts = c("contr.treatment", "contr.poly"))

#upload data
QuantData <- read.csv("DivFirst_quantdata_20250226_.csv")

```

```{r, include=FALSE}
#Data Formatting
QuantData$Q109_text <- factor(QuantData$Q109_text, levels=c("Not LGBTQ","LGBTQ"))  #,"Decline to State"))
QuantData$Class_text <- factor(QuantData$Class_text, levels=c('Traditional','Treatment'))
QuantData$Class_LGBTQ <-factor(QuantData$Class_LGBTQ, levels=c('Traditional_Not LGBTQ','Traditional_LGBTQ','Treatment_Not LGBTQ',"Treatment_LGBTQ"))
QuantData$Gender <- factor(QuantData$Gender, levels=c('Man','Woman','TGNC'))
QuantData$Gender_Combo <- factor(QuantData$Gender_Combo, levels=c('Man','Woman_TGNC'))
QuantData$Class_Gender <- factor(QuantData$Class_Gender, levels=c('Traditional_Man','Traditional_Woman_TGNC','Treatment_Man',"Treatment_Woman_TGNC"))
QuantData$Q110_Group_Simple <- factor(QuantData$Q110_Group_Simple, levels=c('Negative', "No Impact", 'Positive'))
QuantData$Q110_Group_text <- factor(QuantData$Q110_Group_text, levels=c('Very Negative', 'Moderately Negative','Slightly Negative','No Impact','Slightly Positive','Moderately Positive','Very Positive'))
QuantData$Q112_text <- factor(QuantData$Q112_text, levels=c("Strongly Disagree", "Disagree","Slightly Disagree",'Neither',"Slightly Agree","Agree","Strongly Agree"))
QuantData$Q112_Simple <- factor(QuantData$Q112_Simple, levels=c("Disagree",'Neither',"Agree"))
QuantData$Q114_text <- factor(QuantData$Q114_text, levels=c("Strongly Disagree", "Disagree","Slightly Disagree",'Neither',"Slightly Agree","Agree","Strongly Agree"))
QuantData$Q114_Simple <- factor(QuantData$Q114_Simple, levels=c("Disagree",'Neither',"Agree"))
QuantData$Q106_text <- factor(QuantData$Q106_text, levels=c("Strongly Disagree", "Disagree","Slightly Disagree",'Neither',"Slightly Agree","Agree","Strongly Agree"))
QuantData$Q106_Simple <- factor(QuantData$Q106_Simple, levels=c("Disagree",'Neither',"Agree"))
```

# RQ1: Models and Results
## Feel Included
Students were asked “Are there ways sex and gender have been taught or discussed that made you feel included in this class?”(Y/N).
We calculated the percentage of students who said yes or no by Section, Gender, and LGBTQ Identity.  

```{r}
QuantData %>% subset(!is.na(Q100_text)) -> QuantData_Q100subset

#Count Students
Q100_StudentCounts <- QuantData_Q100subset %>% distinct(ResponseId,.keep_all = TRUE) %>% count(Class_text)
Q100_StudentCounts_gender <- QuantData_Q100subset %>% subset(!is.na(Gender)) %>% distinct(ResponseId,.keep_all = TRUE) %>% group_by(Gender) %>% count(Class_text)
Q100_StudentCounts_gendercombo <- QuantData_Q100subset %>% subset(!is.na(Gender_Combo)) %>% distinct(ResponseId,.keep_all = TRUE) %>% group_by(Gender_Combo) %>% count(Class_text)
Q100_StudentCounts_lgbt <- QuantData_Q100subset %>% subset(!is.na(Q109_text)) %>% distinct(ResponseId,.keep_all = TRUE) %>% group_by(Q109_text) %>% count(Class_text)

#Make Summary Tables
Q100_Summary <- QuantData_Q100subset %>% count(Q100_text) %>% 
  mutate(Percent=100*(n/sum(n))) 
Q100_Summary_class <- QuantData_Q100subset %>% group_by(Class_text) %>% count(Q100_text) %>% 
  mutate(Percent=case_when(Class_text=="Traditional" ~ 100*(n/196), Class_text=="Treatment" ~ 100*(n/169))) 

Q100_Summary_class_gender <- QuantData_Q100subset %>% subset(!is.na(Gender)) %>% group_by(Class_text,Gender) %>% count(Q100_text) %>% 
  mutate(Percent=case_when(Class_text=="Traditional" & Gender=="Man"   ~ 100*(n/57), 
                           Class_text=="Traditional" & Gender=="Woman" ~ 100*(n/117), 
                           Class_text=="Traditional" & Gender=="TGNC"  ~ 100*(n/3), 
                           Class_text=="Treatment"   & Gender=="Man"   ~ 100*(n/49), 
                           Class_text=="Treatment"   & Gender=="Woman" ~ 100*(n/104), 
                           Class_text=="Treatment"   & Gender=="TGNC"  ~ 100*(n/5))) 

Q100_Summary_class_gendercombo <- QuantData_Q100subset %>% subset(!is.na(Gender_Combo)) %>% group_by(Class_text,Gender_Combo) %>% count(Q100_text) %>% 
  mutate(Percent=case_when(Class_text=="Traditional" & Gender_Combo=="Man"        ~ 100*(n/57), 
                           Class_text=="Traditional" & Gender_Combo=="Woman_TGNC" ~ 100*(n/120), 
                           Class_text=="Treatment"   & Gender_Combo=="Woman_TGNC" ~ 100*(n/109), 
                           Class_text=="Treatment"   & Gender_Combo=="Man"        ~ 100*(n/49))) 

Q100_Summary_class_lgbtq <- QuantData_Q100subset %>% subset(!is.na(Q109_text)) %>% group_by(Class_text,Q109_text) %>% count(Q100_text) %>% 
  mutate(Percent=case_when(Class_text=="Traditional" & Q109_text=="Not LGBTQ" ~ 100*(n/144), 
                           Class_text=="Traditional" & Q109_text=="LGBTQ"     ~ 100*(n/30), 
                           Class_text=="Treatment"   & Q109_text=="Not LGBTQ" ~ 100*(n/133), 
                           Class_text=="Treatment"   & Q109_text=="LGBTQ"     ~ 100*(n/19))) 


#Create Combined table for bar graph
Q100_Summary_class_lgbtq  %>% gather("Demographic","Value", Q109_text) -> Q100_Summary_class_lgbtq_tocombine
Q100_Summary_class_gender %>% gather("Demographic","Value", Gender) -> Q100_Summary_class_gender_tocombine
Q100_Summary_class$Demographic <- c("Class","Class","Class","Class")
Q100_Summary_class$Value <- c("Class Total","Class Total","Class Total","Class Total")

bind_rows(Q100_Summary_class,Q100_Summary_class_gender_tocombine,Q100_Summary_class_lgbtq_tocombine) -> Q100_combinedsummary

Q100_combinedsummary$Value <- factor(Q100_combinedsummary$Value,levels=c("Man","Woman","TGNC","Not LGBTQ","LGBTQ","Class Total"))
Q100_combinedsummary$Demographic <- factor(Q100_combinedsummary$Demographic,levels=c("Class","Q109_text","Gender"))

Q100_combinedsummary_wider <- Q100_combinedsummary %>% pivot_wider(names_from="Class_text",values_from=c("n","Percent"),values_fill=0) %>% data.frame  

Q100_combinedsummary <- Q100_combinedsummary %>% unite("Class_DemCat", c(Class_text,Demographic), na.rm = TRUE, remove = FALSE) 
Q100_combinedsummary$Class_DemCat <- factor(Q100_combinedsummary$Class_DemCat,levels=c("Treatment_Class","Treatment_Q109_text","Treatment_Gender","Traditional_Class","Traditional_Q109_text","Traditional_Gender"))

subset(Q100_combinedsummary,Q100_text == "Yes") -> Q100_combined_summary_forbar

```


```{r echo=FALSE, fig.width=7, fig.height=3}
#plot % yes by demographic
Q100_summary_bar_total<- ggplot(subset(Q100_combined_summary_forbar,Q100_text == "Yes"), aes(x=Percent/100, y=Value, fill=fct_rev(Class_DemCat))) +
#  geom_col(position=position_dodge(),color="black",show.legend= FALSE) +
  geom_col(position=position_dodge(),show.legend= FALSE) +
    theme_classic() +     
 scale_fill_manual(values=c("#DBACCCFF","#DBACCCFF","#C692B4FF","#AAD5C1FF","#AAD5C1FF","#4B988FFF"))+
  theme(panel.grid = element_blank())+ 
  ylab("")+
  xlab("Percent of Students Who Feel Included") +
  scale_x_reverse(limits=c(1.13,0),labels = label_percent(),breaks=c(1,.75,.5,.25,0))+
  scale_y_discrete(position="right")+
 #   ggtitle("Percent of Students Who Feel Included") +
  theme(axis.ticks.y=element_blank(),
 #       plot.title=element_text(size=8, face="bold"),
        axis.text.y = element_text(size = 15),
        axis.text.x = element_text(size = 13),
        axis.title=element_text(size=16)) +
  geom_text(aes(label=percent(Percent/100, accuracy=.1),hjust = 1.1), position=position_dodge(width=0.9),size=4.5,fontface="bold") +
showSignificance( .95, c(4.25,5.25), -0.01, ".",textParams = list(angle=90,size=5)) +
showSignificance( .99, c(3.75,5.25), -0.01, "*",textParams = list(angle=90,size=6,vjust=.25))
Q100_summary_bar_total
```

The results were then tested for significant differences using the generalized linear model:
```{r}
includedGLM_fullinteraction <- glm((Q100-1) ~ Class_text*Q109_text+Class_text*Gender_Combo, data=QuantData_Q100subset, family=binomial, na.action=na.exclude)
summary(includedGLM_fullinteraction)
```

We then calculated estimated marginal means and pair-wise comparison for the variables Section and LGBTQ. The model is: 
```{r}
emmeans(includedGLM_fullinteraction, pairwise ~ Class_text*Q109_text)
```

We then calculated the odds ratio for each group compared to the control of Traditional-Not LGBTQ students with the model where “Section_LGBTQ” is a combined variable of Section and LGBTQ identity: 
```{r}
includedLGBTQ_Class_glm <- glm(as.factor(Q100_text) ~ Class_LGBTQ, data=(QuantData), family=binomial, na.action=na.exclude) #Yes is signifigant
summary(includedLGBTQ_Class_glm)
summary(includedLGBTQ_Class_glm)$coefficients
includedLGBTQ_Class_glm_oddsratios_95CI <- exp(confint(includedLGBTQ_Class_glm))
includedLGBTQ_Class_glm_oddsratios <- exp(coef(includedLGBTQ_Class_glm))

coefs <- summary(includedLGBTQ_Class_glm)$coefficients
oddsratio_table <- cbind(coefs[ ,c("Estimate", "Pr(>|z|)")],
                          odds_ratio = includedLGBTQ_Class_glm_oddsratios,
                          includedLGBTQ_Class_glm_oddsratios_95CI,question="Q100") 
oddsratio_table <- as.data.frame.matrix(oddsratio_table)

oddsratio_table <- tibble::rownames_to_column(oddsratio_table, "Fixed.Effect") 
oddsratio_table$odds_ratio <- as.numeric(oddsratio_table$odds_ratio)
oddsratio_table$CI_2.5 <- as.numeric(oddsratio_table$`2.5 %`)
oddsratio_table$CI97.5 <- as.numeric(oddsratio_table$`97.5 %`)
oddsratio_table %>% subset (Fixed.Effect != "(Intercept)") -> oddsratio_table_plot
```

```{r echo=FALSE, fig.width=7, fig.height=3}
oddsratio_table_plot$Fixed.Effect <- factor(oddsratio_table_plot$Fixed.Effect, levels=c("Class_LGBTQTreatment_LGBTQ","Class_LGBTQTreatment_Not LGBTQ","Class_LGBTQTraditional_LGBTQ"))

oddsratio_table_plot$Group[oddsratio_table_plot$Fixed.Effect=="Class_LGBTQTraditional_Not LGBTQ"] <- "Traditional Not LGBTQ+"
oddsratio_table_plot$Group[oddsratio_table_plot$Fixed.Effect=="Class_LGBTQTreatment_LGBTQ"] <- "Treatment LGBTQ+"
oddsratio_table_plot$Group[oddsratio_table_plot$Fixed.Effect=="Class_LGBTQTreatment_Not LGBTQ"] <- "Treatment Not LGBTQ+"
oddsratio_table_plot$Group[oddsratio_table_plot$Fixed.Effect=="Class_LGBTQTraditional_LGBTQ"] <- "Traditional LGBTQ+"
oddsratio_table_plot$Group <- factor(oddsratio_table_plot$Group, levels=c("Treatment LGBTQ+","Treatment Not LGBTQ+","Traditional LGBTQ+","Traditional Not LGBTQ+"))

oddsgraph <- ggplot(oddsratio_table_plot, aes(x=odds_ratio, y=fct_rev(Group))) +
  theme_classic() +
  geom_vline(aes(xintercept=1), linetype="dashed", color="black") +
  geom_point(aes(color=Group), size=6) +
  scale_color_manual(values=c( "#AAD5C1FF","#4B988FFF","#C692B4FF")) +
#  guides(color=guide_legend("Fixed.Effect")) +
#  facet_grid(rows=vars(question), switch="both") +
  geom_errorbar(aes(xmin=CI_2.5, xmax=CI97.5),width=.1) +
  theme(legend.position = "none") +
  xlim(0,22)+
#  theme(axis.text.y=element_blank()) +
  theme(axis.ticks.y=element_blank(),
 #       plot.title=element_text(size=8, face="bold"),
        axis.text.y = element_text(size = 15),
        axis.text.x = element_text(size = 13),
        axis.title=element_text(size=16)) +
  labs(x="Odds of Feeling Included",y="")+
  scale_y_discrete(labels=c("LGBTQ+","Not LGBTQ+","LGBTQ+"))+
  showSignificance( 21, c(3,3), 0, "***",textParams=list(size=6))+
  showSignificance(4, c(1.98,1.98), 0, "n.s.",textParams=list(size=4,angle=0))+
  showSignificance(5, c(.98,.98), 0, "n.s.",textParams=list(size=4,angle=0))
oddsgraph
#impact_combined_figure <- plot_grid(Q100_summary_bar_total,oddsgraph,Q101summary_bar,ncol=3,rel_widths = c(1,.7,1.1),labels = c('A', 'B','C'),scale=0.95,label_size=18)
#width 465; height 1996
#impact_combined_figure
```

## Feel Uncomfortable
Students were asked “Are there ways sex and gender have been taught or discussed in this class that made you feel uncomfortable?” Y/N). 
We calculated the percentage of students who said yes or no by Section, Gender, and LGBTQ Identity.  
```{r}
QuantData %>% subset(!is.na(Q98_text)) -> Q98_subset

Q98_StudentCounts <- Q98_subset %>% count(Class_text)
Q98_StudentCounts_gender <- Q98_subset %>% subset(!is.na(Gender)) %>% group_by(Gender) %>% count(Class_text)
Q98_StudentCounts_gendercombo <- Q98_subset %>% subset(!is.na(Gender_Combo)) %>% group_by(Gender_Combo) %>% count(Class_text)
Q98_StudentCounts_lgbtq <- Q98_subset %>% subset(!is.na(Q109_text)) %>% group_by(Q109_text) %>% count(Class_text)

#Make summary tables with percents
Q98_summary <- Q98_subset %>% count(Q98_text)
Q98_class_summary <- Q98_subset %>% group_by(Class_text) %>% count(Q98_text) %>% mutate(Percent=case_when(Class_text=="Traditional" ~ 100*(n/198), Class_text=="Treatment" ~ 100*(n/169))) 
Q98_class_gender_summary <- Q98_subset %>% subset(!is.na(Gender)) %>% group_by(Class_text,Gender) %>% count(Q98_text) %>% 
  mutate(Percent = case_when(Class_text=="Traditional" & Gender=="Man"   ~ 100*(n/57), 
                             Class_text=="Traditional" & Gender=="Woman" ~ 100*(n/117), 
                             Class_text=="Traditional" & Gender=="TGNC"  ~ 100*(n/3), 
                             Class_text=="Treatment"   & Gender=="Man"   ~ 100*(n/49), 
                             Class_text=="Treatment"   & Gender=="Woman" ~ 100*(n/104), 
                             Class_text=="Treatment"   & Gender=="TGNC"  ~ 100*(n/5))) 

Q98_class_gendercombo_summary <- Q98_subset %>% subset(!is.na(Gender_Combo)) %>% group_by(Class_text,Gender_Combo) %>% count(Q98_text) %>%
  mutate(Percent = case_when(Class_text=="Traditional" & Gender_Combo=="Man"        ~ 100*(n/57), 
                             Class_text=="Traditional" & Gender_Combo=="Woman_TGNC" ~ 100*(n/120), 
                             Class_text=="Treatment"   & Gender_Combo=="Man"        ~ 100*(n/49), 
                             Class_text=="Treatment"   & Gender_Combo=="Woman_TGNC" ~ 100*(n/109))) 

Q98_class_lgbtq_summary <- Q98_subset %>% subset(!is.na(Q109_text)) %>% group_by(Class_text,Q109_text) %>% count(Q98_text) %>%
  mutate(Percent = case_when(Class_text=="Traditional" & Q109_text=="Not LGBTQ" ~ 100*(n/144),
                             Class_text=="Traditional" & Q109_text=="LGBTQ"     ~ 100*(n/30), 
                             Class_text=="Treatment"   & Q109_text=="Not LGBTQ" ~ 100*(n/133), 
                             Class_text=="Treatment"   & Q109_text=="LGBTQ"     ~ 100*(n/19))) 

#Create Combined table for bar graph
Q98_class_lgbtq_summary  %>% gather("Demographic","Value", Q109_text) -> Q98_Summary_class_lgbtq_tocombine
Q98_class_gender_summary %>% gather("Demographic","Value", Gender) -> Q98_Summary_class_gender_tocombine
Q98_class_summary$Demographic <- c("Class","Class","Class")
Q98_class_summary$Value <- c("Class Total","Class Total","Class Total")

bind_rows(Q98_class_summary,Q98_Summary_class_gender_tocombine,Q98_Summary_class_lgbtq_tocombine) -> Q98_combinedsummary

Q98_combinedsummary$Value <- factor(Q98_combinedsummary$Value,levels=c("Man","Woman","TGNC","Not LGBTQ","LGBTQ","Class Total"))
Q98_combinedsummary$Demographic <- factor(Q98_combinedsummary$Demographic,levels=c("Class","Q109_text","Gender"))

Q98_combinedsummary_wider <- Q98_combinedsummary %>% pivot_wider(names_from="Class_text",values_from=c("n","Percent"),values_fill=0) %>% data.frame  

Q98_combinedsummary <- Q98_combinedsummary %>% unite("Class_DemCat", c(Class_text,Demographic), na.rm = TRUE, remove = FALSE) 
Q98_combinedsummary$Class_DemCat <- factor(Q98_combinedsummary$Class_DemCat,levels=c("Treatment_Class","Treatment_Q109_text","Treatment_Gender","Traditional_Class","Traditional_Q109_text","Traditional_Gender"))

subset(Q98_combinedsummary,Q98_text == "No") -> Q98_combined_summary_forbar
```

The results were then tested for significant differences using the generalized linear model:
```{r}
uncomfortableGLM_fullinteraction <- glm((Q98-1) ~ Class_text*Q109_text+Class_text*Gender_Combo, data=Q98_subset, family=binomial, na.action=na.exclude)
summary(uncomfortableGLM_fullinteraction)
```




# RQ2: Models and Results
## Impact on Experience in Course
Students in the Treatment section were asked “The lecture on sexual diversity in the beginning of the course had _______ impact on my experience in the course:” with options (1) “a very negative”, (2) “a moderately negative”, (3) “a slightly negative”, (4) “no impact”, (5) “a slightly positive”, (6) “a moderately positive”, (7) “a very positive”.
We calculated the percentage of students who said yes or no by Gender and LGBTQ Identity.  
```{r}
Q110_subset <- QuantData %>% subset(!is.na(Q110))
#Student Counts
Q110_StudentCount <- QuantData %>% subset(!is.na(Q110)) %>% count(Class_text)
Q110_StudentCount_Gender <- QuantData %>% subset(!is.na(Q110) & !is.na(Gender)) %>% count(Gender) 
Q110_StudentCount_GenderCombo <- QuantData %>% subset(!is.na(Q110) & !is.na(Gender)) %>% count(Gender_Combo) 
Q110_StudentCount_LGBT <-  QuantData %>% subset(!is.na(Q110) & !is.na(Q109_text)) %>% count(Q109_text)

#Make Summary Tables
Q110_Summary <- QuantData %>% subset(!is.na(Q110)) %>% count(Q110_Group_text) %>% mutate(Percent=100*(n/sum(n)))
Q110_Summary_Simple <- QuantData %>% subset(!is.na(Q110)) %>% count(Q110_Group_Simple) %>% mutate(Percent=100*(n/sum(n)))

Q110_Summary_Gender <-QuantData %>% subset(!is.na(Q110) & !is.na(Gender)) %>% group_by(Gender) %>%count(Q110_Group_text) %>% 
  mutate(Percent =case_when(Gender=="Man"~100*(n/49), 
                            Gender=="Woman"~100*(n/104), 
                            Gender=="TGNC"~100*(n/5)))

Q110_Summary_Gender_Simple <- QuantData %>% subset(!is.na(Q110) & !is.na(Gender)) %>% group_by(Gender) %>%count(Q110_Group_Simple) %>% 
  mutate(Percent =case_when(Gender=="Man"~100*(n/49), 
                            Gender=="Woman"~100*(n/104), 
                            Gender=="TGNC"~100*(n/5)))

Q110_Summary_GenderCombo <- QuantData %>% subset(!is.na(Q110) & !is.na(Gender)) %>% group_by(Gender_Combo) %>%count(Q110_Group_text) %>% 
  mutate(Percent =case_when(Gender_Combo=="Man"~100*(n/49), 
                            Gender_Combo=="Woman_TGNC"~100*(n/109)))

Q110_Summary_GenderCombo_Simple <-QuantData %>% subset(!is.na(Q110) & !is.na(Gender)) %>% group_by(Gender_Combo) %>%count(Q110_Group_Simple) %>% 
  mutate(Percent =case_when(Gender_Combo=="Man"~100*(n/49), 
                            Gender_Combo=="Woman_TGNC"~100*(n/109)))

Q110_Summary_LGBTQ <-  QuantData %>% subset(!is.na(Q110) & !is.na(Q109_text)) %>% group_by(Q109_text) %>%count(Q110_Group_text) %>% 
  mutate(Percent =case_when(Q109_text=="Not LGBTQ"~100*(n/133), 
                            Q109_text=="LGBTQ"~100*(n/19)))

Q110_Summary_LGBTQ_Simple <- QuantData %>% subset(!is.na(Q110) & !is.na(Q109_text)) %>% group_by(Q109_text) %>%count(Q110_Group_Simple) %>% 
  mutate(Percent =case_when(Q109_text=="Not LGBTQ"~100*(n/133), 
                            Q109_text=="LGBTQ"~100*(n/19)))
```

The results were then tested for significant differences using the generalized linear model:
```{r}
CourseExperienceGLM <- glm(as.integer(Q110) ~ Gender_Combo+Q109_text, data=Q110_subset, na.action=na.exclude) 
summary(CourseExperienceGLM )
coef(summary(CourseExperienceGLM))
confint.default(CourseExperienceGLM)
```

## Connection to course content
Students in the Treatment section were asked “The lecture on sexual diversity in the beginning of the course made me feel more connected to the biology course content” with the option of selection (1) “Strongly disagree” to (7) “Strongly Agree.”
We calculated the percentage of students who said yes or no by Gender and LGBTQ Identity.  
```{r}
Q112_subset <- QuantData %>% subset(!is.na(Q112))
#Student Counts
Q112_StudentCount <- QuantData %>% subset(!is.na(Q112)) %>% count(Class_text)
Q112_StudentCount_Gender <- QuantData %>% subset(!is.na(Q112) & !is.na(Gender)) %>% count(Gender) 
Q112_StudentCount_GenderCombo <- QuantData %>% subset(!is.na(Q112) & !is.na(Gender)) %>% count(Gender_Combo) 
Q112_StudentCount_LGBT <- QuantData %>% subset(!is.na(Q112) & !is.na(Q109_text)) %>% count(Q109_text)

#Make Summary Tables
Q112_Summary <- QuantData %>% subset(!is.na(Q112)) %>% count(Q112_text) %>% mutate(Percent=100*(n/sum(n)))
Q112_Summary_Simple <- QuantData %>% subset(!is.na(Q112)) %>% count(Q112_Simple) %>% mutate(Percent=100*(n/sum(n)))

Q112_Summary_Gender <- QuantData %>% subset(!is.na(Q112) & !is.na(Gender)) %>% group_by(Gender) %>%count(Q112_text) %>% 
  mutate(Percent =case_when(Gender=="Man"  ~100*(n/49), 
                            Gender=="Woman"~100*(n/103), 
                            Gender=="TGNC" ~100*(n/5)))

Q112_Summary_Gender_Simple <- QuantData %>% subset(!is.na(Q112) & !is.na(Gender)) %>% group_by(Gender) %>% count(Q112_Simple) %>% 
  mutate(Percent =case_when(Gender=="Man"  ~100*(n/49), 
                            Gender=="Woman"~100*(n/103), 
                            Gender=="TGNC" ~100*(n/5)))

Q112_Summary_GenderCombo <- QuantData %>% subset(!is.na(Q112) & !is.na(Gender)) %>% group_by(Gender_Combo) %>%count(Q112_text) %>% 
  mutate(Percent =case_when(Gender_Combo=="Man"       ~100*(n/49), 
                            Gender_Combo=="Woman_TGNC"~100*(n/108)))

Q112_Summary_GenderCombo_Simple <- QuantData %>% subset(!is.na(Q112) & !is.na(Gender))  %>% group_by(Gender_Combo) %>% count(Q112_Simple) %>% 
  mutate(Percent=case_when(Gender_Combo=="Man"       ~100*(n/49), 
                           Gender_Combo=="Woman_TGNC"~100*(n/108)))

Q112_Summary_LGBTQ <- QuantData %>% subset(!is.na(Q112) & !is.na(Q109_text)) %>% group_by(Q109_text) %>%count(Q112_text) %>% 
  mutate(Percent =case_when(Q109_text=="Not LGBTQ"~100*(n/132), 
                            Q109_text=="LGBTQ"    ~100*(n/19)))

Q112_Summary_LGBTQ_Simple <- QuantData %>% subset(!is.na(Q112) & !is.na(Q109_text)) %>% group_by(Q109_text) %>% count(Q112_Simple) %>% 
  mutate(Percent=case_when(Q109_text=="Not LGBTQ"~100*(n/132), 
                           Q109_text=="LGBTQ"    ~100*(n/19)))

```

The results were then tested for significant differences using the generalized linear model:
```{r}
MoreConnectedGLM <- glm(as.integer(Q112) ~ Gender_Combo+Q109_text, data=Q112_subset, na.action=na.exclude) 
summary(MoreConnectedGLM )
coef(summary(MoreConnectedGLM))
   
confint.default(MoreConnectedGLM)

```


## Sense of Belonging
Students were asked “The lecture on sexual diversity in the beginning of the course increased my sense of belonging in the classroom” with the option of selection (1) “Strongly disagree” to (7) “Strongly Agree.”
We calculated the percentage of students who said yes or no by Gender and LGBTQ Identity.  
```{r}
Q114_subset <- QuantData %>% subset(!is.na(Q114))
#Student Counts
Q114_StudentCount <- QuantData %>% subset(!is.na(Q114)) %>% count(Class_text)
Q114_StudentCount_Gender <- QuantData %>% subset(!is.na(Q114) & !is.na(Gender)) %>% count(Gender) 
Q114_StudentCount_GenderCombo <- QuantData %>% subset(!is.na(Q114) & !is.na(Gender)) %>% count(Gender_Combo) 
Q114_StudentCount_LGBT <- QuantData %>% subset(!is.na(Q114) & !is.na(Q109_text)) %>% count(Q109_text)

#Make Summary Tables
Q114_Summary <- QuantData %>% subset(!is.na(Q114)) %>% count(Q114_text) %>% mutate(Percent=100*(n/sum(n)))
Q114_Summary_Simple <- QuantData %>% subset(!is.na(Q114)) %>% count(Q114_Simple) %>% mutate(Percent=100*(n/sum(n)))

Q114_Summary_Gender <- QuantData %>% subset(!is.na(Q114) & !is.na(Gender))%>% group_by(Gender) %>%count(Q114_text) %>% 
  mutate(Percent =case_when(Gender=="Man"  ~100*(n/49), 
                            Gender=="Woman"~100*(n/103), 
                            Gender=="TGNC" ~100*(n/5)))

Q114_Summary_Gender_Simple <- QuantData %>% subset(!is.na(Q114) & !is.na(Gender)) %>% group_by(Gender) %>% count(Q114_Simple) %>% 
  mutate(Percent =case_when(Gender=="Man"  ~100*(n/49), 
                            Gender=="Woman"~100*(n/103), 
                            Gender=="TGNC" ~100*(n/5)))

Q114_Summary_GenderCombo <- QuantData %>% subset(!is.na(Q114) & !is.na(Gender)) %>% group_by(Gender_Combo) %>%count(Q114_text) %>% 
  mutate(Percent =case_when(Gender_Combo=="Man"       ~100*(n/49), 
                            Gender_Combo=="Woman_TGNC"~100*(n/108)))

Q114_Summary_GenderCombo_Simple <- QuantData %>% subset(!is.na(Q114) & !is.na(Gender)) %>% group_by(Gender_Combo) %>% count(Q114_Simple) %>% 
  mutate(Percent=case_when(Gender_Combo=="Man"         ~100*(n/49), 
                           Gender_Combo == "Woman_TGNC"~100*(n/108)))

Q114_Summary_LGBTQ <- QuantData %>% subset(!is.na(Q114) & !is.na(Q109_text))  %>% group_by(Q109_text) %>%count(Q114_text) %>% 
  mutate(Percent =case_when(Q109_text=="Not LGBTQ"~100*(n/132), 
                            Q109_text=="LGBTQ"    ~100*(n/19)))

Q114_Summary_LGBTQ_Simple <- QuantData %>% subset(!is.na(Q114) & !is.na(Q109_text))  %>% group_by(Q109_text) %>% count(Q114_Simple) %>% 
  mutate(Percent=case_when(Q109_text=="Not LGBTQ"~100*(n/132), 
                           Q109_text == "LGBTQ"  ~100*(n/19)))
```

The results were then tested for significant differences using the generalized linear model:
```{r}
IncreaseBelongingGLM <- glm(as.integer(Q114) ~ Gender_Combo+Q109_text, data=Q114_subset, na.action=na.exclude) 
summary(IncreaseBelongingGLM )
coef(summary(IncreaseBelongingGLM))
  
confint.default(IncreaseBelongingGLM)
```


## Likert plot: Impact, Connection, Sense of Belonging
```{r echo=FALSE, fig.width=7, fig.height=10}
QuantData %>% subset(Class_text=="Treatment") %>% dplyr::select(X,ResponseId,Q109_text,Gender,Q110,Q114,Q112,Q110_Group_text,Q114_text,Q112_text) -> DataFigure2
DataFigure2 %>% dplyr::select(X,ResponseId,Q109_text,Gender,Q110,Q110_Group_text) -> DataQ110
DataFigure2 %>% dplyr::select(X,ResponseId,Q109_text,Gender,Q112,Q112_text) -> DataQ112
DataFigure2 %>% dplyr::select(X,ResponseId,Q109_text,Gender,Q114,Q114_text) -> DataQ114

likert_levelsQ110 <- c("Very Negative","Moderately Negative","Slightly Negative","No Impact", "Slightly Positive", "Moderately Positive","Very Positive")
likert_levelsQ112_Q114 <- c("Strongly Disagree", "Disagree","Slightly Disagree","Neither", "Slightly Agree","Agree", "Strongly Agree")

DataQ110 %>% pivot_wider(names_from=Q109_text,values_from=Q110_Group_text) %>% dplyr::select(ResponseId,Q110,'Not LGBTQ',LGBTQ) -> DataQ110w1
DataQ110 %>% pivot_wider(names_from=Gender,values_from=Q110_Group_text) %>% dplyr::select(ResponseId,Q110,Woman, Man, TGNC) -> DataQ110w2
full_join(DataQ110w1,DataQ110w2,by=c("ResponseId","Q110")) -> DataQ110w
DataQ110w %>% dplyr::select(LGBTQ,'Not LGBTQ', TGNC, Woman, Man) -> DataQ110_lk
DataQ110_lk %>% mutate(across(everything(), ~ factor(.x, levels = likert_levelsQ110))) -> DataQ110_lk

DataQ112 %>% pivot_wider(names_from=Q109_text,values_from=Q112_text) %>% dplyr::select(ResponseId,Q112,'Not LGBTQ',LGBTQ) -> DataQ112w1
DataQ112 %>% pivot_wider(names_from=Gender,values_from=Q112_text) %>% dplyr::select(ResponseId,Q112,Woman, Man, TGNC) -> DataQ112w2
full_join(DataQ112w1,DataQ112w2,by=c("ResponseId","Q112")) -> DataQ112w
DataQ112w %>% dplyr::select(LGBTQ,'Not LGBTQ', TGNC, Woman, Man) -> DataQ112_lk
DataQ112_lk %>% mutate(across(everything(), ~ factor(.x, levels = likert_levelsQ112_Q114))) -> DataQ112_lk

DataQ114 %>% pivot_wider(names_from=Q109_text,values_from=Q114_text) %>% dplyr::select(ResponseId,Q114,'Not LGBTQ',LGBTQ) -> DataQ114w1
DataQ114 %>% pivot_wider(names_from=Gender,values_from=Q114_text) %>% dplyr::select(ResponseId,Q114,Woman, Man, TGNC) -> DataQ114w2
full_join(DataQ114w1,DataQ114w2,by=c("ResponseId","Q114")) -> DataQ114w
DataQ114w %>% dplyr::select(LGBTQ,'Not LGBTQ', TGNC, Woman, Man)-> DataQ114_lk
DataQ114_lk %>% mutate(across(everything(), ~ factor(.x, levels = likert_levelsQ112_Q114))) -> DataQ114_lk

Q110_likertplot <- gglikert(DataQ110_lk,add_totals = FALSE) +ggtitle("Impact on Course Experience") +scale_x_continuous(limits=c(-1,1),breaks=c(-1,-.5,0,.5,1),labels=c("100%", "50%", "0","50%","100%")) +scale_fill_manual(values=c(rev(paletteer_c("ggthemes::Purple", 3)),"#F6F6F7",rev(paletteer_c("grDevices::Mint", 3))))  +
  showSignificance( -.73, c(4,5), 0.03, "***") +
  showSignificance( -.73, c(1,2.5), 0.03, "*")+
  showSignificance( -.7, c(2,3), 0, "")
Q112_likertplot <-gglikert(DataQ112_lk,add_totals = FALSE) +ggtitle("Increase Connection to Course Content")+scale_x_continuous(limits=c(-1,1),breaks=c(-1,-.5,0,.5,1),labels=c("100%", "50%", "0","50%","100%")) +scale_fill_manual(values=c(rev(paletteer_c("ggthemes::Purple", 3)),"#F6F6F7",rev(paletteer_c("grDevices::Mint", 3))))   +
  showSignificance( -.73, c(4,5), 0.03, "**") +
  showSignificance( -.73, c(1,2.5), 0.03, ".")+
  showSignificance( -.7, c(2,3), 0, "")
Q114_likertplot <-gglikert(DataQ114_lk,add_totals = FALSE) +ggtitle("Increase Sense of Belonging")+scale_x_continuous(limits=c(-1,1),breaks=c(-1,-.5,0,.5,1),labels=c("100%", "50%", "0","50%","100%")) +scale_fill_manual(values=c(rev(paletteer_c("ggthemes::Purple", 3)),"#F6F6F7",rev(paletteer_c("grDevices::Mint", 3))))   +
  showSignificance( -.73, c(4,5), 0.03, "**") +
  showSignificance( -.73, c(1,2.5), 0.03, "" )+ ## adds significant line for gender
  showSignificance(-.75,c(1.75,1.75),0,"n.s", textParams = list(angle=90))+ ## only adds the "n.s" label because it was upside down in previous line
  showSignificance( -.7, c(2,3), 0, "") ## adds straight line above women tgnc

#put the plots together
likert_combo <- plot_grid(Q110_likertplot,Q112_likertplot,Q114_likertplot,nrow=3,labels = c('A', 'B','C'),scale=0.95,label_size=18)

likert_combo
```

# RQ4: Models and Results 
## Naturalistic Fallacy 
Students in both sections were asked “If non-human animals act a particular way, does that mean that it is ethical for humans to act that way?” to which they could respond Yes/No. We tested for differences between sections with the model: 
```{r}
QuantData %>% subset(!is.na(Q105_text)) %>% count(Class_text) -> Q105_StudentCounts
QuantData %>% subset(!is.na(Q105_text)) %>% group_by(Class_text) %>% count(Q105_text) %>% 
  mutate(Percent=case_when(Class_text=="Traditional" ~ 100*(n/180), Class_text=="Treatment" ~ 100*(n/160))) -> Q105_Summary_class

nonhumanethicalGLM <- glm(as.factor(Q105) ~ Class_text, data=QuantData, family=binomial, na.action=na.exclude) 
summary(nonhumanethicalGLM) #notsignifigant
```


We then asked students if they agree/disagree with the statement “Behaviors are morally/ethically ‘good’ if they are found in nature” with the options (1) “Strongly disagree” to (7) “Strongly agree”, and tested for differences between sections with the model: 
```{r}
QuantData %>% subset(!is.na(Q106)) %>% count(Class_text) -> Q106_StudentCount
QuantData %>% subset(!is.na(Q106)) %>% group_by(Class_text) %>% count(Q106_text)  %>% 
  mutate(Percent=case_when(Class_text=="Traditional" ~ 100*(n/180), Class_text=="Treatment" ~ 100*(n/160))) -> Q106_Summary_class

QuantData %>% subset(!is.na(Q106)) %>% group_by(Class_text) %>% count(Q106_Simple)  %>% 
  mutate(Percent=case_when(Class_text=="Traditional" ~ 100*(n/180), Class_text=="Treatment" ~ 100*(n/160))) -> Q106_Summary_class_simple

Q106_Summary_class_wider <- Q106_Summary_class %>% pivot_wider(names_from="Class_text",values_from=c("n","Percent"),values_fill=0) %>% data.frame  
Q106_Summary_class_simple_wider <- Q106_Summary_class_simple %>% pivot_wider(names_from="Class_text",values_from=c("n","Percent"),values_fill=0) %>% data.frame  

NatureEthicsGLM <- glm(as.integer(Q106) ~ Class_text, data=QuantData, na.action=na.exclude) 
summary(NatureEthicsGLM) #notsignifigant


```

```{r echo=FALSE, fig.width=7, fig.height=3}
likert_levelsQ106 <- c("1","2","3","4", "5", "6","7")
likert_levelsQ106 <- c("Strongly Disagree", "Disagree","Slightly Disagree","Neither", "Slightly Agree","Agree", "Strongly Agree")

QuantData %>% dplyr::select(X,ResponseId,Class_text,Q106_text) -> DataQ106
DataQ106 %>% pivot_wider(names_from=Class_text,values_from=Q106_text) %>% dplyr::select(Treatment,Traditional) -> DataQ106
DataQ106 %>% mutate(across(everything(), ~ factor(.x, levels = likert_levelsQ106))) -> DataQ106
#purple to mint: +scale_fill_manual(values=c(rev(paletteer_c("ggthemes::Purple", 3)),"#F6F6F7",rev(paletteer_c("grDevices::Mint", 3)))) 
Q106_likertplot <- gglikert(DataQ106,add_totals = TRUE) +ggtitle("Behaviors are Morally/Ethical Good if Found in Nature") +scale_x_continuous(limits=c(-1,1),breaks=c(-1,-.5,0,.5,1),labels=c("100%", "50%", "0","50%","100%")) +scale_fill_manual(values=c(rev(paletteer_c("ggthemes::Purple", 3)),"#F6F6F7",rev(paletteer_c("grDevices::Mint", 3)))) #+ scale_x_continuous(limits=c(-1,1),breaks=c(-1,-.5,0,.5,1),labels=c("100%", "50%", "0","50%","100%"))

Q106_likertplot
```
